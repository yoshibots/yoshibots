

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Nginx &mdash; Blue Field v1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

  
  <script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6785010150916443"
       crossorigin="anonymous">
  </script>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-4CD4ZD75QT"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4CD4ZD75QT');
  </script>
  </script>

  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Blue Field
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../os.html">OS</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../network.html">NETWORK</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../development.html">DEVELOPMENT</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../middleware.html">MIDDLEWARE</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../database.html">DATABASE</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cloud.html">CLOUD</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../virtualization.html">VIRTUALIZATION</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../framework.html">FRAMEWORK</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../texteditor.html">TEXTEDITOR</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../other.html">OTHER</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Main:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../main.html">main</a></li>
<li class="toctree-l1"><a class="reference internal" href="../selinux.html">SELinux</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Blue Field</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Nginx</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/source/middleware/nginx.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="nginx">
<h1>Nginx<a class="headerlink" href="#nginx" title="Permalink to this headline">¶</a></h1>
<p># 事前準備</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Firewall</span>
<span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="nb">list</span><span class="o">-</span><span class="nb">all</span>                       <span class="c1"># 確認</span>
<span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">service</span><span class="o">=</span><span class="n">http</span> <span class="o">--</span><span class="n">permanent</span>   <span class="c1"># デフォルトポートの場合</span>
<span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">port</span><span class="o">=&lt;</span><span class="n">XXX</span><span class="o">&gt;/</span><span class="n">tcp</span> <span class="o">--</span><span class="n">permanent</span> <span class="c1"># ポートを変更する場合</span>
<span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">reload</span>
</pre></div>
</div>
<p>SELinux
semanage port -a -t http_port_t -p tcp &lt;8080&gt; # ポートを変更した場合はポートにラベルを割り当てる</p>
<p># 構築手順</p>
<p># Nginxのリポジトリを追加する
# vi /etc/yum.repos.d/nginx.repoに下記を記載</p>
<p># /etc/yum.repos.d/nginx.repo ————————
[nginx]
name=nginx repo
baseurl=http://nginx.org/packages/centos/7/$basearch/
gpgcheck=0
enabled=1</p>
<p># —————————————————-</p>
<p># EPELリポジトリの追加
sudo yum install epel-release</p>
<p># Install
yum install nginx</p>
<p># とりあえずListen,server_nameだけ変更しておく</p>
<p>vi /etc/nginx/conf.d/cnapp.conf</p>
<p>## /etc/nginx/conf.d/cnapp.conf ———————–</p>
<p>-listen 80;
+listen 8088;</p>
<p>-server_name localhost;
+server_name cnweb3;</p>
<hr class="docutils" />
<dl>
<dt># 自動起動を設定して起動する場合</dt><dd><p>systemctl enable –now nginx.service</p>
<p>■ よく使用するコマンド</p>
<p># 設定ファイルの構文確認
&gt; nginx -t</p>
<p># 設定ファイルのリロード
&gt; systemctl reload nginx || &gt; nginx -s reload</p>
<p># =================================================================+
# Security対策                                                     +
# =================================================================+</p>
<p>Niktoによる脆弱性診断を行う</p>
<dl>
<dt>change port</dt><dd><p><a href="#id1"><span class="problematic" id="id2">|</span></a>__listen &lt;8088&gt;;</p>
<dl>
<dt>Hide version</dt><dd><p><a href="#id3"><span class="problematic" id="id4">|</span></a>__server_tokens off;</p>
<dl>
<dt>Etag</dt><dd><p><a href="#id5"><span class="problematic" id="id6">|</span></a>__etag off;</p>
<dl>
<dt>Clickjacking</dt><dd><p><a href="#id7"><span class="problematic" id="id8">|</span></a>__add_header x-frame-options (“DENY” | “SAMEORIGIN”) # SAMEORIGIN - 自身と生成元が同じフレーム内に限りページを表示
XSS</p>
<blockquote>
<div><dl>
<dt><a href="#id9"><span class="problematic" id="id10">|</span></a>__add_header x-content-type-options “nosniff”        # UserAgentがContent-typeに従わなければならない</dt><dd><p><a href="#id11"><span class="problematic" id="id12">|</span></a>__add_header x-xss-protection “1; mode=block”        # IE/Chrome/Safari においてXSS攻撃を検知してした際に読み込むことを防止する</p>
<dl>
<dt>MITM</dt><dd><dl>
<dt><a href="#id13"><span class="problematic" id="id14">|</span></a>__add_header strict-transport-security “max-age=31536000; includeSubDomains” # HSTS TLS使用を強制する.</dt><dd><p>includeSubDomainsはポリシーをサブドメインにも適用する
XST</p>
<blockquote>
<div><p><a href="#id15"><span class="problematic" id="id16">|</span></a>__NginxではデフォルトでTRACEメソッド許容していない。</p>
<dl>
<dt>Options - Indexes(autoindex)</dt><dd><p><a href="#id17"><span class="problematic" id="id18">|</span></a>__Nginxではデフォルトでインデックスページ非表示の為、不要。</p>
<ul class="simple">
<li><p>Option</p></li>
</ul>
<dl>
<dt>Request size limit</dt><dd><p><a href="#id19"><span class="problematic" id="id20">|</span></a>__client_max_body_size &lt;1k&gt;; # リクエストヘッダを1kbに制限する</p>
<p># Ref
Top 7 HTTP security headers to specify and how to deploy them
<a class="reference external" href="https://www-templarbit-com.translate.goog/blog/jp/2018/07/24/top-http-security-headers-and-how-to-deploy-them/?_x_tr_sl=ja&amp;_x_tr_tl=en&amp;_x_tr_hl=en&amp;_x_tr_pto=sc">https://www-templarbit-com.translate.goog/blog/jp/2018/07/24/top-http-security-headers-and-how-to-deploy-them/?_x_tr_sl=ja&amp;_x_tr_tl=en&amp;_x_tr_hl=en&amp;_x_tr_pto=sc</a></p>
<p>Nginxセキュリティ設定
<a class="reference external" href="https://qiita.com/hideji2/items/1421f9bff2a97a5e5794">https://qiita.com/hideji2/items/1421f9bff2a97a5e5794</a></p>
<p># ——————————————————————+
# WAF                                                               +
# ——————————————————————+</p>
<dl>
<dt>設置形態により下記の種類にわけられる</dt><dd><dl>
<dt><a href="#id21"><span class="problematic" id="id22">|</span></a>__SaaS型（クラウド型）</dt><dd><dl>
<dt><a href="#id23"><span class="problematic" id="id24">|</span></a>__ゲートウェイ型（ネットワーク型）</dt><dd><p><a href="#id25"><span class="problematic" id="id26">|</span></a>__ホスト型（ソフトウェア型）</p>
<p># Mod Security(ホスト型)
# NAXSI</p>
<p># ——————————————————————+
# 国外からのアクセスを制限する                                      +
# ——————————————————————+</p>
<p>&#64;Nginxで国外からのWEBアクセスを遮断
<a class="reference external" href="https://qiita.com/KensukeSakakibara/items/27d15975c754758321ad">https://qiita.com/KensukeSakakibara/items/27d15975c754758321ad</a></p>
<p>&#64;Nginxで一部海外IPからのアクセスを遮断する
<a class="reference external" href="https://programming-beginner-zeroichi.jp/articles/125">https://programming-beginner-zeroichi.jp/articles/125</a></p>
<p>&gt; cd /etc/nginx/</p>
<p>#
&gt; wget <a class="reference external" href="http://nami.jp/ipv4bycc/cidr.txt.gz">http://nami.jp/ipv4bycc/cidr.txt.gz</a></p>
<p>&gt; gunzip cidr.txt.gz</p>
<p>&gt; sed -n ‘s/^JPt(.*)/allow 1;/p’ cidr.txt &gt; /etc/nginx/allowip.conf # Whitlist方式</p>
<p># nginx.confに下記で記載</p>
<p>/etc/nginx.conf —————————————————-
http {</p>
<blockquote>
<div><dl>
<dt>・・・</dt><dd><dl>
<dt># Allow IP</dt><dd><dl>
<dt>include /etc/nginx/allowip.conf;</dt><dd><p>deny all;</p>
<blockquote>
<div><p>include /etc/nginx/conf.d/<a href="#id27"><span class="problematic" id="id28">*</span></a>.conf;
}
/etc/nginx.conf end ————————————————</p>
<p>&gt; nginx -s reload</p>
<p># 検証
VPNを用いて国外アクセスの検証を行う
access forbidden by ruleと記載されることを確認</p>
<p><a href="#id29"><span class="problematic" id="id30">*</span></a>IPが更新されるので定期的にリストをUpdateすることも必要なので暫定対応とする</p>
<div class="line-block">
<div class="line"><a class="reference external" href="https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-centos-7">How To Install Nginx on CentOS 7</a></div>
<div class="line"><a class="reference external" href="https://qiita.com/kidach1/items/985efebba639713c562e">IPベースでのアクセス制限の準備(中段)</a></div>
<div class="line"><a class="reference external" href="https://www.mk-mode.com/blog/2013/02/17/nginx-logrotation/">Nginx - ログローテーション設定！</a></div>
<div class="line"><a class="reference external" href="https://www.mk-mode.com/blog/2013/02/17/nginx-logrotation/">Why does nginx starts process as root?</a></div>
<div class="line"><a class="reference external" href="https://qiita.com/morrr/items/7c97f0d2e46f7a8ec967">nginxについてまとめ(設定編)</a></div>
<div class="line"><a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-XSS-Protection">X-XSS-Protection</a></div>
<div class="line"><a class="reference external" href="https://rin-ka.net/nginx01/">Nginx よく使う設定</a></div>
<div class="line"><a class="reference external" href="https://rin-ka.net/nginx-proxy-cache/">【実践】Nginx のリバースプロキシでファイルをキャッシュする方法</a></div>
<div class="line"><a class="reference external" href="https://oki2a24.com/2019/07/01/setting-to-use-both-80-and-443-port-in-nginx/">80 番ポートへのアクセスを 443 番ポートへのアクセスに強制する設定</a></div>
</div>
<p>))}’)’))””””””””””)]</p>
</div></blockquote>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, yoshi.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>